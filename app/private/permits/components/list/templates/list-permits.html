<div ng-include="'app/private/permits/components/list/templates/permit-header.html'"></div>

<h2>Permits: {{currentPage}}</h2>

<div ng-show="permits.length > 0">
    Permits displayed: <b>{{permitsGrid.api.getDisplayedRowCount()
    }}</b><br /><br />
    </div>
    <div class="alert alert-primary" role="alert" ng-hide="permits">
        Good things come to those who wait... (loading...)
    </div>
    <div ng-show="permitsGrid.hasFilters" style="margin-bottom: 10px;"><button class="btn-sm btn-warning" ng-click="clearFilters()">Clear Filters</button></div>
    <div id="active-permits-grid" style="height: 200px;width:100%;" class="ag-theme-blue"></div>

    <div class="alert alert-secondary" role="alert" ng-hide="permitsGrid.selectedItem || !permits">Click a permit to display details.</div>

    <div ng-show="permitsGrid.selectedItem">

        <div class="modal-body modal-form" style="width: 100% !important;">

            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a id="tab-status" class="nav-link active" data-toggle="tab" data-target="#permitstatus">Permit Status</a>
                </li>
                <li class="nav-item">
                    <a id="tab-basicinfo" class="nav-link" data-toggle="tab" data-target="#basicinfo">Details</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" data-target="#actions">Activities</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" data-target="#payment">Fee</a>
                </li>
            </ul>

            <div style="margin-top: -40px; margin-right:9px; display:flex;" class="right">
                <div style="margin-left: 5px;" ng-show="(row.PermitStatus=='Approved' || row.PermitStatus=='Conditionally Approved')"><button ng-click="openPermitReport()" class="btn btn-sm">Generate Permit</button></div>
                <div style="margin-left: 5px;" ng-show="row.COIssueDate"><button ng-click="openCOReport()" class="btn btn-sm">Generate CO</button></div>
            </div>

            <div ng-show="Profile.hasRole('Permits') && row.dataChanged" style="margin: 10px; float: right;">
                <div class="alert alert-danger" ng-show="row.hasError">{{row.errorMessage}}</div>
                <button ng-disabled="row.isSaving" class="btn btn-warning" ng-click="cancel()">Cancel</button>
                <button ng-disabled="row.isSaving" class="btn btn-primary" ng-click="save()">Save</button>
            </div>


            <form novalidate class="row-form modal-form" style="width: 100%;" name="headerForm">

                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="permitstatus">
                            <div class="list-group media-list media-list-stream">

                                <h2>{{row.ProjectName}} ({{row.PermitStatus}})</h2>

                                <div class="panel panel-default" style="width: 1200px;">
                                    <div class="panel-body">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr><th>TPO Action</th><th>Date</th><th>Status</th><th style="max-width: 400px;" width="400">Comments</th></tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>Application Received</td>
                                                    <td>{{row.ApplicationDate | date : shortDate}}</td>
                                                    <td>&nbsp;</td>
                                                    <td>&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td>Permit Status: </td>
                                                    <td>{{row.StatusDate | date : shortDate}}</td>
                                                    <td>{{row.PermitStatus}}</td>
                                                    <td>{{row.StatusNotes}}</td>
                                                </tr>
                                                <tr>
                                                    <td>Fee Status</td>
                                                    <td>
                                                        <span ng-if="row.FeeNotificationDate && !row.FeePaymentDate">{{row.FeeNotificationDate | date :shortDate}}</span>
                                                        <span ng-if="row.FeePaymentDate">{{row.FeePaymentDate | date :shortDate}}</span>
                                                    </td>
                                                    <td>
                                                        <span ng-if="row.FeeNotificationDate && !row.FeePaymentDate">&#9898</span>
                                                        <span ng-if="row.FeePaymentDate">&#9899</span>
                                                    </td>
                                                    <td><span ng-if="row.Fee">{{row.Fee | currency}}</span></td>
                                                </tr>

                                                <tr>
                                                    <td>Permit Issued</td>
                                                    <td>{{row.IssueDate | date : shortDate}}</td>
                                                    <td><span ng-if="row.IssuedBy">By {{row.IssuedBy}}</span></td>
                                                    <td>{{row.PermitConditions}}</td>
                                                </tr>

                                                <tr>
                                                    <td>File Status</td>
                                                    <td>{{row.FileStatus}}</td>
                                                    <td>{{row.CloseDate | date : shortDate}}</td>
                                                    <td>&nbsp;</td>
                                                </tr>

                                                <tr>
                                                    <td><b>Routes</b></td>
                                                    <td>&nbsp;</td>
                                                    <td>&nbsp;</td>
                                                    <td>&nbsp;</td>
                                                </tr>

                                                <tr ng-repeat="status in PermitStatus | filter:{EventType: 'Review'}">
                                                    <td> - {{status.ItemType}} </td>
                                                    <td>{{status.RequestDate | date: shortDate}}</td>
                                                    <td>
                                                        <span ng-if="status.RequestDate && !status.ResponseDate">&#9898</span>
                                                        <span ng-if="status.RequestDate && status.ResponseDate">&#9899</span>
                                                    </td>
                                                    <td>{{status.Comments}}</td>
                                                </tr>

                                                <tr>
                                                    <td><b>Inspections</b></td>
                                                    <td>&nbsp;</td>
                                                    <td>&nbsp;</td>
                                                    <td>&nbsp;</td>
                                                </tr>

                                                <tr ng-repeat="status in PermitStatus | filter:{EventType: 'Inspection'}">
                                                    <td> - {{status.ItemType}}</td>
                                                    <td>{{status.RequestDate | date: shortDate}}</td>
                                                    <td>
                                                        <span ng-if="status.RequestDate && !status.ResponseDate">&#9898</span>
                                                        <span ng-if="status.ResponseDate && status.ResponseDate">&#9899</span>
                                                    </td>
                                                    <td>{{status.Result}} {{status.Comments}}</td>
                                                </tr>
                                                
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                    </div>

                    <div role="tabpanel" class="tab-pane" id="basicinfo">
                        <div class="list-group media-list media-list-stream">

                            <h2>{{row.ProjectName}} ({{row.PermitStatus}})</h2>
                            
                            <div class="row">

                                <div class="col-lg-4" style="min-width: 450px;">
                                    <fieldset>
                                        <legend class="bump-over">General Information</legend>
                                        <div ng-repeat="field in permitsGrid.columnDefs | filter:{ColumnIndex:1}" ng-switch on="field.ControlType">
                                            <ctuir-text-field ng-switch-when="text"></ctuir-text-field>
                                            <ctuir-textarea-field ng-switch-when="textarea"></ctuir-textarea-field>
                                            <ctuir-number-field ng-switch-when="number"></ctuir-number-field>
                                            <ctuir-date-field ng-switch-when="date"></ctuir-date-field>
                                            <ctuir-time-field ng-switch-when="time"></ctuir-time-field>
                                            <ctuir-checkbox-field ng-switch-when="checkbox"></ctuir-checkbox-field>
                                            <ctuir-select-field ng-switch-when="select"></ctuir-select-field>
                                            <ctuir-select-number-field ng-switch-when="select-number"></ctuir-select-number-field>
                                            <ctuir-multiselect-field ng-switch-when="multiselect"></ctuir-multiselect-field>
                                            <ctuir-currency-field ng-switch-when="currency"></ctuir-currency-field>
                                            <ctuir-text-field ng-switch-default></ctuir-text-field>
                                        </div>
                                    </fieldset>
                                </div>

                                <div class="col-lg-4" style="min-width: 450px;">
                                    <fieldset>
                                        <legend class="bump-over">Location Information</legend>
                                        <div ng-repeat="field in permitsGrid.columnDefs | filter:{ColumnIndex:2}" ng-switch on="field.ControlType">
                                            <ctuir-text-field ng-switch-when="text"></ctuir-text-field>
                                            <ctuir-textarea-field ng-switch-when="textarea"></ctuir-textarea-field>
                                            <ctuir-number-field ng-switch-when="number"></ctuir-number-field>
                                            <ctuir-date-field ng-switch-when="date"></ctuir-date-field>
                                            <ctuir-time-field ng-switch-when="time"></ctuir-time-field>
                                            <ctuir-checkbox-field ng-switch-when="checkbox"></ctuir-checkbox-field>
                                            <ctuir-select-field ng-switch-when="select"></ctuir-select-field>
                                            <ctuir-select-number-field ng-switch-when="select-number"></ctuir-select-number-field>
                                            <ctuir-multiselect-field ng-switch-when="multiselect"></ctuir-multiselect-field>
                                            <ctuir-text-field ng-switch-default></ctuir-text-field>
                                        </div>

                                        <div class="form-group">
                                            <div class="header-label">Zoning</div>
                                            <div class="header-value">
                                                <select class="form-control" ng-blur="onHeaderEditingStopped({'DbColumnName':'Zoning'})" multiple ng-model="row.Zoning" >
                                                    <option ng-repeat="zone in row.Zones | orderBy:'+'" value="{{zone}}">{{zone}}</option>
                                                </select>
                                            </div>
                                        </div>


                                    </fieldset>
                                    <fieldset style="margin-top: 30px;">
                                        <legend class="bump-over">Other Information</legend>
                                        <div ng-repeat="field in permitsGrid.columnDefs | filter:{ColumnIndex:3}" ng-switch on="field.ControlType">
                                            <ctuir-text-field ng-switch-when="text"></ctuir-text-field>
                                            <ctuir-textarea-field ng-switch-when="textarea"></ctuir-textarea-field>
                                            <ctuir-number-field ng-switch-when="number"></ctuir-number-field>
                                            <ctuir-date-field ng-switch-when="date"></ctuir-date-field>
                                            <ctuir-time-field ng-switch-when="time"></ctuir-time-field>
                                            <ctuir-checkbox-field ng-switch-when="checkbox"></ctuir-checkbox-field>
                                            <ctuir-select-field ng-switch-when="select"></ctuir-select-field>
                                            <ctuir-select-number-field ng-switch-when="select-number"></ctuir-select-number-field>
                                            <ctuir-multiselect-field ng-switch-when="multiselect"></ctuir-multiselect-field>
                                            <ctuir-text-field ng-switch-default></ctuir-text-field>
                                        </div>
                                    </fieldset>

                                    <fieldset style="margin-top: 30px;">
                                        <legend class="bump-over">Routing</legend>
                                        <div class="checkbox-fix" ng-repeat="field in permitsGrid.columnDefs | filter:{ColumnIndex:6}" ng-switch on="field.ControlType">
                                            <ctuir-multiselect-checkbox-field ng-switch-when="multiselect-checkbox"></ctuir-multiselect-checkbox-field>
                                        </div>
                                    </fieldset>

                                </div>

                                <div class="col-lg-4" style="min-width: 480px;">
                                    <fieldset>
                                        <legend>Contacts</legend>
                                        <div id="permit-contacts-grid" style="height: 120px;width:100%;" class="ag-theme-blue"></div>
                                        <button ng-show="row.Id" class="btn btn-secondary btn-sm right margin-5" ng-click="openContactModal()">Add</button>
                                        <button ng-show="permitContactsGrid.selectedItem" class="btn btn-warning btn-sm right margin-5" ng-click="removeSelectedContact()">Remove</button>
                                    </fieldset>
                                    <fieldset style=" margin-top: 30px;">
                                        <legend>Parcels</legend>
                                        <div id="permit-parcels-grid" style="height: 120px;width:100%;" class="ag-theme-blue"></div>
                                        <button ng-show="permitParcelsGrid.selectedItem" class="btn btn-secondary btn-sm right margin-5" ng-click="openParcelInMap()">Open in Map</button>
                                        <button ng-show="row.Id" class="btn btn-secondary btn-sm right margin-5" ng-click="openParcelModal()">Add</button>
                                        <button ng-show="permitParcelsGrid.selectedItem" class="btn btn-warning btn-sm right margin-5" ng-click="removeSelectedParcel()">Remove</button>
                                    </fieldset>
                                    <fieldset style=" margin-top: 30px;">
                                        <legend>Parcel History</legend>
                                        <div id="parcel-history-grid" style="height: 120px;width:100%;" class="ag-theme-blue"></div>
                                    </fieldset>
                                    <fieldset style=" margin-top: 30px;">
                                        <legend>Documents</legend>
                                        <div id="permit-files-grid" style="height: 200px;width:100%;" class="ag-theme-blue"></div>
                                        <button ng-show="row.Id" class="btn btn-secondary btn-sm right margin-5" ng-click="openFileModal()">Add</button>
                                        <button ng-show="permitFilesGrid.selectedItem && !permitFilesGrid.selectedItem.ItemId" class="btn btn-warning btn-sm right margin-5" ng-click="removeSelectedFile()">Remove</button>
                                    </fieldset>
                                </div>


                            </div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane fade in" id="actions">
                        <div class="list-group media-list media-list-stream">
                            <div style="margin-top: 30px;"></div>
                            <button class="btn btn-sm" ng-click="openActivityModal()">Add Activity</button>
                            <button class="btn btn-sm" ng-click="openActivityModal(null,'new_inspection')">Request Inspection</button>
                            <button class="btn btn-sm" ng-click="openActivityModal(null,'new_route')">Request Review</button>
                            <div style="margin-top: 10px;"></div>
                            <div id="permit-events-grid" style="height: 200px;width:100%;" class="ag-theme-blue"></div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane fade in" id="payment">
                        <div class="list-group media-list media-list-stream">
                            <div style="margin-top: 30px;"></div>

                            <div class="container">
                                <div class="row">
                                    <div class="col-lg">
                                        <div ng-repeat="field in permitsGrid.columnDefs | filter:{ColumnIndex:5}" ng-switch on="field.ControlType">
                                            <ctuir-text-field ng-switch-when="text"></ctuir-text-field>
                                            <ctuir-currency-field ng-switch-when="currency"></ctuir-currency-field>
                                            <ctuir-textarea-field ng-switch-when="textarea"></ctuir-textarea-field>
                                            <ctuir-number-field ng-switch-when="number"></ctuir-number-field>
                                            <ctuir-date-field ng-switch-when="date"></ctuir-date-field>
                                            <ctuir-time-field ng-switch-when="time"></ctuir-time-field>
                                            <ctuir-checkbox-field ng-switch-when="checkbox"></ctuir-checkbox-field>
                                            <ctuir-select-field ng-switch-when="select"></ctuir-select-field>
                                            <ctuir-select-number-field ng-switch-when="select-number"></ctuir-select-number-field>
                                            <ctuir-multiselect-field ng-switch-when="multiselect"></ctuir-multiselect-field>
                                            <ctuir-text-field ng-switch-default></ctuir-text-field>
                                        </div>
                                    </div>
                                    <div class="col-lg">
                                            
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </form>
            <div class="modal-footer">
                <div ng-show="Profile.hasRole('Permits') && row.dataChanged" style="margin: 10px; float: right;">
                    <div class="alert alert-danger" ng-show="row.hasError">{{row.errorMessage}}</div>
                    <button ng-disabled="row.isSaving" class="btn btn-warning" ng-click="cancel()">Cancel</button>
                    <button ng-disabled="row.isSaving" class="btn btn-primary" ng-click="save()">Save</button>
                </div>
            </div>

        </div>

    </div>
